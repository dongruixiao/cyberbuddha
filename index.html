<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Buddha - x402</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #0a0a0a;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', monospace;
        }
        .container {
            text-align: center;
            padding: 20px;
        }
        .buddha {
            color: #00ff88;
            font-size: 12px;
            line-height: 1.2;
            white-space: pre;
            text-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88;
            animation: glow 2s ease-in-out infinite alternate;
            font-family: monospace;
            display: inline-block;
            text-align: left;
        }
        .title {
            color: #00ff88;
            font-size: 12px;
            margin-top: 20px;
            letter-spacing: 8px;
            text-shadow: 0 0 10px #00ff88;
        }
        @keyframes glow {
            from { text-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88; opacity: 0.8; }
            to { text-shadow: 0 0 20px #00ff88, 0 0 40px #00ff88, 0 0 60px #00ff88; opacity: 1; }
        }

        /* ä¸Šé¦™åŒºåŸŸ */
        .offering-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #00ff8844;
            border-radius: 8px;
            background: #0a0a0a99;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .offering-title {
            color: #00ff88;
            font-size: 14px;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #00ff88;
        }
        .x402-badge {
            display: inline-block;
            padding: 2px 8px;
            background: linear-gradient(90deg, #7c3aed, #2563eb);
            border-radius: 4px;
            font-size: 10px;
            color: white;
            margin-left: 8px;
        }

        /* é¦™çš„å®¹å™¨ */
        .incense-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            min-height: 60px;
        }
        .incense {
            width: 4px;
            height: 50px;
            background: linear-gradient(to top, #ff6600, #ffaa00);
            border-radius: 2px;
            position: relative;
            animation: incenseBurn 3s ease-in-out infinite;
        }
        .incense::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 15px;
            background: #ff4400;
            border-radius: 50% 50% 20% 20%;
            animation: flame 0.5s ease-in-out infinite alternate;
            box-shadow: 0 0 10px #ff6600, 0 0 20px #ff4400;
        }
        .incense::after {
            content: '';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 20px;
            background: linear-gradient(to top, #888, transparent);
            animation: smoke 2s ease-out infinite;
            opacity: 0.6;
        }
        @keyframes incenseBurn { 0%, 100% { height: 50px; } 50% { height: 48px; } }
        @keyframes flame { from { transform: translateX(-50%) scale(1); } to { transform: translateX(-50%) scale(1.2); } }
        @keyframes smoke { 0% { opacity: 0.6; top: -30px; } 100% { opacity: 0; top: -60px; } }

        /* é’±åŒ…ä¿¡æ¯ */
        .wallet-info {
            color: #00ff8888;
            font-size: 10px;
            margin-bottom: 5px;
        }
        .network-info {
            color: #ffaa00aa;
            font-size: 10px;
            margin-bottom: 15px;
        }

        /* è¾“å…¥æ¡† */
        .input-field {
            width: 100%;
            padding: 10px;
            background: #111;
            border: 1px solid #00ff8844;
            border-radius: 4px;
            color: #00ff88;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 15px;
            outline: none;
        }
        .input-field:focus {
            border-color: #00ff88;
            box-shadow: 0 0 10px #00ff8833;
        }
        .input-field::placeholder { color: #00ff8866; }

        /* é¦™çš„é€‰æ‹© */
        .offering-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .offering-btn {
            padding: 12px 8px;
            background: transparent;
            border: 1px solid #00ff8866;
            border-radius: 4px;
            color: #00ff88;
            font-family: monospace;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .offering-btn:hover, .offering-btn.selected {
            background: #00ff8822;
            border-color: #00ff88;
            box-shadow: 0 0 15px #00ff8844;
        }
        .offering-btn .price {
            display: block;
            font-size: 14px;
            font-weight: bold;
            margin-top: 4px;
            color: #ffaa00;
        }

        /* æŒ‰é’® */
        .btn {
            padding: 12px 24px;
            background: transparent;
            border: 1px solid #00ff88;
            color: #00ff88;
            font-family: monospace;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn:hover {
            background: #00ff8822;
            box-shadow: 0 0 15px #00ff8844;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-connect {
            border-color: #ffaa00;
            color: #ffaa00;
        }
        .btn-connect:hover {
            background: #ffaa0022;
            box-shadow: 0 0 15px #ffaa0044;
        }
        .btn-offer {
            width: 100%;
            margin-top: 10px;
            padding: 15px;
            font-size: 14px;
        }

        /* çŠ¶æ€ */
        .status {
            color: #00ff8888;
            font-size: 11px;
            margin-top: 15px;
            min-height: 20px;
        }
        .status.error { color: #ff4444; }
        .status.success { color: #00ff88; }
        .status a { color: #00ff88; }

        /* ç¥ç¦åŠ¨ç”» */
        .blessing-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffaa00;
            font-size: 24px;
            text-shadow: 0 0 20px #ffaa00, 0 0 40px #ff6600;
            animation: blessingPop 2s ease-out forwards;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
        }
        @keyframes blessingPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            80% { opacity: 1; transform: translate(-50%, -60%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -70%) scale(0.8); }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #00ff8844;
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
<pre class="buddha">                  _oo0oo_
                 o8888888o
                 88" . "88
                 (| -_- |)
                 0\  =  /0
               ___/`---'\___
             .' \\|     |// '.
            / \\|||  :  |||// \
           / _||||| -:- |||||- \
          |   | \\\  -  /// |   |
          | \_|  ''\---/''  |_/ |
          \  .-\__  '-'  ___/-. /
        ___'. .'  /--.--\  `. .'___
     ."" '<  `.___\_<|>_/___.' >' "".
    | | :  `- \`.;`\ _ /`;.`/ - ` : | |
    \  \ `_.   \_ __\ /__ _/   .-` /  /
=====`-.____`.___ \_____/___.-`___.-'=====
                  `=---='

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
          ä½›ç¥–ä¿ä½‘         æ°¸ç„¡BUG
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</pre>
        <div class="title">C Y B E R _ B U D D H A <span class="x402-badge">x402</span></div>

        <div class="offering-section">
            <div class="offering-title">~ èµ›åšä¸Šé¦™ Â· é“¾ä¸Šè®¸æ„¿ ~</div>

            <div class="incense-container" id="incenseContainer"></div>

            <div class="wallet-info" id="walletInfo">æœªè¿æ¥é’±åŒ…</div>
            <div class="network-info" id="networkInfo"></div>

            <input type="text" class="input-field" id="wishInput" placeholder="è¾“å…¥ä½ çš„æ„¿æœ›..." maxlength="100">

            <div class="offering-options" id="offeringOptions">
                <button class="offering-btn" data-type="small">
                    å°é¦™<span class="price">$0.10</span>
                </button>
                <button class="offering-btn selected" data-type="medium">
                    ä¸­é¦™<span class="price">$1.00</span>
                </button>
                <button class="offering-btn" data-type="large">
                    å¤§é¦™<span class="price">$5.00</span>
                </button>
                <button class="offering-btn" data-type="premium">
                    é«˜é¦™<span class="price">$10.00</span>
                </button>
            </div>

            <button class="btn btn-connect" id="connectBtn">è¿æ¥é’±åŒ…</button>
            <button class="btn btn-offer" id="offerBtn" disabled>ğŸ™ ä¸Šé¦™è®¸æ„¿</button>

            <div class="status" id="status"></div>
        </div>
    </div>

    <script>
        // API åŸºç¡€è·¯å¾„
        const API_BASE = '';

        // x402 é…ç½®
        let selectedOffering = 'medium';
        let userAddress = null;
        let currentChainId = null;
        let serverConfig = null;

        // DOM
        const connectBtn = document.getElementById('connectBtn');
        const offerBtn = document.getElementById('offerBtn');
        const wishInput = document.getElementById('wishInput');
        const status = document.getElementById('status');
        const walletInfo = document.getElementById('walletInfo');
        const networkInfo = document.getElementById('networkInfo');
        const incenseContainer = document.getElementById('incenseContainer');
        const offeringBtns = document.querySelectorAll('.offering-btn');

        // è·å–æœåŠ¡ç«¯é…ç½®
        async function fetchConfig() {
            try {
                const res = await fetch(`${API_BASE}/api/config`);
                serverConfig = await res.json();
                networkInfo.textContent = `ç½‘ç»œ: ${serverConfig.network}`;
            } catch (e) {
                console.error('è·å–é…ç½®å¤±è´¥:', e);
            }
        }

        // é€‰æ‹©é¦™çš„ç±»å‹
        offeringBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                offeringBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedOffering = btn.dataset.type;
            });
        });

        // è¿æ¥é’±åŒ…
        connectBtn.addEventListener('click', async () => {
            if (!window.ethereum) {
                setStatus('è¯·å®‰è£… MetaMask æˆ–å…¶ä»– Web3 é’±åŒ…', 'error');
                return;
            }

            try {
                setStatus('<span class="loading"></span>æ­£åœ¨è¿æ¥é’±åŒ…...');

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                userAddress = accounts[0];

                const chainIdHex = await window.ethereum.request({ method: 'eth_chainId' });
                currentChainId = parseInt(chainIdHex, 16);

                updateWalletUI();
                setStatus('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');

            } catch (error) {
                console.error(error);
                setStatus('è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        });

        function updateWalletUI() {
            if (userAddress) {
                const shortAddr = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
                walletInfo.textContent = `å·²è¿æ¥: ${shortAddr}`;
                connectBtn.textContent = 'å·²è¿æ¥';
                connectBtn.disabled = true;
                offerBtn.disabled = false;
            }
        }

        // ç½‘ç»œé…ç½®
        const NETWORK_CONFIG = {
            'base-sepolia': { chainId: 84532, name: 'Base Sepolia', rpc: 'https://sepolia.base.org' },
            'base': { chainId: 8453, name: 'Base', rpc: 'https://mainnet.base.org' },
        };

        // åˆ‡æ¢ç½‘ç»œ
        async function switchToNetwork(networkName) {
            const config = NETWORK_CONFIG[networkName];
            if (!config) return false;

            const chainIdHex = '0x' + config.chainId.toString(16);

            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: chainIdHex }],
                });
                currentChainId = config.chainId;
                return true;
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: chainIdHex,
                                chainName: config.name,
                                rpcUrls: [config.rpc],
                                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 }
                            }],
                        });
                        currentChainId = config.chainId;
                        return true;
                    } catch (e) {
                        console.error('æ·»åŠ ç½‘ç»œå¤±è´¥:', e);
                        return false;
                    }
                }
                return false;
            }
        }

        // ä¸Šé¦™ - x402 æµç¨‹
        offerBtn.addEventListener('click', async () => {
            if (!userAddress) {
                setStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            const wish = wishInput.value.trim() || 'å¿ƒè¯šåˆ™çµ';
            const offering = serverConfig?.offerings?.find(o => o.id === selectedOffering);
            if (!offering) {
                setStatus('è¯·é€‰æ‹©é¦™çš„ç±»å‹', 'error');
                return;
            }

            try {
                setStatus('<span class="loading"></span>æ­£åœ¨è¯·æ±‚æ”¯ä»˜...');
                offerBtn.disabled = true;

                // Step 1: å‘èµ·è¯·æ±‚ï¼Œè·å– 402 å“åº”
                const response = await fetch(`${API_BASE}${offering.path}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wish })
                });

                // å¦‚æœä¸æ˜¯ 402ï¼Œè¯´æ˜ä¸éœ€è¦æ”¯ä»˜ï¼ˆä¸å¤ªå¯èƒ½ï¼‰
                if (response.status !== 402) {
                    const data = await response.json();
                    handleSuccess(data, wish);
                    return;
                }

                // Step 2: è§£æ 402 å“åº”ï¼Œè·å–æ”¯ä»˜è¦æ±‚
                const paymentRequired = await response.json();
                console.log('Payment Required:', paymentRequired);

                if (!paymentRequired.accepts || paymentRequired.accepts.length === 0) {
                    setStatus('æ— æ³•è·å–æ”¯ä»˜è¦æ±‚', 'error');
                    offerBtn.disabled = false;
                    return;
                }

                const requirements = paymentRequired.accepts[0];

                // æ£€æŸ¥å¹¶åˆ‡æ¢ç½‘ç»œ
                const targetNetwork = requirements.network;
                const targetConfig = NETWORK_CONFIG[targetNetwork];
                if (targetConfig && currentChainId !== targetConfig.chainId) {
                    setStatus('<span class="loading"></span>æ­£åœ¨åˆ‡æ¢åˆ° ' + targetConfig.name + '...');
                    const switched = await switchToNetwork(targetNetwork);
                    if (!switched) {
                        setStatus('è¯·æ‰‹åŠ¨åˆ‡æ¢åˆ° ' + targetConfig.name + ' ç½‘ç»œ', 'error');
                        offerBtn.disabled = false;
                        return;
                    }
                }

                setStatus('<span class="loading"></span>è¯·åœ¨é’±åŒ…ä¸­ç­¾åæˆæƒ...');

                // Step 3: åˆ›å»º EIP-3009 æˆæƒç­¾å
                const payment = await createPaymentAuthorization(requirements);

                // Step 4: å¸¦ä¸Š X-PAYMENT header é‡æ–°è¯·æ±‚
                setStatus('<span class="loading"></span>æ­£åœ¨å¤„ç†æ”¯ä»˜...');
                const paymentResponse = await fetch(`${API_BASE}${offering.path}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-PAYMENT': payment
                    },
                    body: JSON.stringify({ wish })
                });

                if (!paymentResponse.ok) {
                    const err = await paymentResponse.json();
                    throw new Error(err.error || 'æ”¯ä»˜å¤±è´¥');
                }

                const result = await paymentResponse.json();

                // è·å–äº¤æ˜“ä¿¡æ¯
                const xPaymentResponse = paymentResponse.headers.get('X-PAYMENT-RESPONSE');
                if (xPaymentResponse) {
                    try {
                        const txInfo = JSON.parse(atob(xPaymentResponse));
                        console.log('Transaction:', txInfo);
                    } catch (e) {}
                }

                handleSuccess(result, wish);

            } catch (error) {
                console.error(error);
                if (error.code === 4001) {
                    setStatus('ç”¨æˆ·å–æ¶ˆäº†ç­¾å', 'error');
                } else {
                    setStatus('æ”¯ä»˜å¤±è´¥: ' + error.message, 'error');
                }
            } finally {
                offerBtn.disabled = false;
            }
        });

        // åˆ›å»º EIP-3009 æ”¯ä»˜æˆæƒ
        async function createPaymentAuthorization(requirements) {
            const { asset, payTo, maxAmountRequired, extra, network } = requirements;

            // ç”Ÿæˆéšæœº nonce (bytes32)
            const nonceBytes = crypto.getRandomValues(new Uint8Array(32));
            const nonce = '0x' + [...nonceBytes].map(b => b.toString(16).padStart(2, '0')).join('');

            const now = Math.floor(Date.now() / 1000);
            const validAfter = 0;  // ç«‹å³ç”Ÿæ•ˆ
            const validBefore = now + 3600;  // 1å°æ—¶åè¿‡æœŸ

            // è·å–æ­£ç¡®çš„ chainId
            const targetConfig = NETWORK_CONFIG[network];
            const chainId = targetConfig ? targetConfig.chainId : currentChainId;

            // EIP-712 Domain
            const domain = {
                name: extra?.name || 'USDC',
                version: extra?.version || '2',
                chainId: chainId,
                verifyingContract: asset
            };

            // EIP-712 ç±»å‹
            const types = {
                TransferWithAuthorization: [
                    { name: 'from', type: 'address' },
                    { name: 'to', type: 'address' },
                    { name: 'value', type: 'uint256' },
                    { name: 'validAfter', type: 'uint256' },
                    { name: 'validBefore', type: 'uint256' },
                    { name: 'nonce', type: 'bytes32' }
                ]
            };

            // ç­¾åæ¶ˆæ¯
            const message = {
                from: userAddress,
                to: payTo,
                value: maxAmountRequired,
                validAfter: validAfter,
                validBefore: validBefore,
                nonce: nonce
            };

            console.log('Signing EIP-712 message:', { domain, message });

            // è¯·æ±‚ç­¾å
            const signature = await window.ethereum.request({
                method: 'eth_signTypedData_v4',
                params: [userAddress, JSON.stringify({
                    types: {
                        EIP712Domain: [
                            { name: 'name', type: 'string' },
                            { name: 'version', type: 'string' },
                            { name: 'chainId', type: 'uint256' },
                            { name: 'verifyingContract', type: 'address' }
                        ],
                        ...types
                    },
                    primaryType: 'TransferWithAuthorization',
                    domain,
                    message
                })]
            });

            console.log('Signature:', signature);

            // æ„é€  x402 payment payload
            const payload = {
                x402Version: 1,
                scheme: 'exact',
                network: network,
                payload: {
                    signature: signature,
                    authorization: {
                        from: userAddress,
                        to: payTo,
                        value: maxAmountRequired,
                        validAfter: validAfter.toString(),
                        validBefore: validBefore.toString(),
                        nonce: nonce
                    }
                }
            };

            console.log('Payment payload:', payload);

            // Base64 ç¼–ç 
            return btoa(JSON.stringify(payload));
        }

        // å¤„ç†æˆåŠŸ
        function handleSuccess(result, wish) {
            addIncense();
            showBlessing(result.blessing || wish);
            wishInput.value = '';
            setStatus(`${result.message || 'ä¸Šé¦™æˆåŠŸï¼'} ğŸ™`, 'success');
        }

        function addIncense() {
            const incense = document.createElement('div');
            incense.className = 'incense';
            incenseContainer.appendChild(incense);
            if (incenseContainer.children.length > 10) {
                incenseContainer.removeChild(incenseContainer.firstChild);
            }
        }

        function showBlessing(text) {
            const blessing = document.createElement('div');
            blessing.className = 'blessing-animation';
            blessing.textContent = text;
            document.body.appendChild(blessing);
            setTimeout(() => blessing.remove(), 2000);
        }

        function setStatus(message, type = '') {
            status.innerHTML = message;
            status.className = 'status ' + type;
        }

        // ç›‘å¬é’±åŒ…äº‹ä»¶
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    userAddress = null;
                    walletInfo.textContent = 'æœªè¿æ¥é’±åŒ…';
                    connectBtn.textContent = 'è¿æ¥é’±åŒ…';
                    connectBtn.disabled = false;
                    offerBtn.disabled = true;
                } else {
                    userAddress = accounts[0];
                    updateWalletUI();
                }
            });

            window.ethereum.on('chainChanged', (chainIdHex) => {
                currentChainId = parseInt(chainIdHex, 16);
            });
        }

        // åˆå§‹åŒ–
        fetchConfig();
    </script>
</body>
</html>
